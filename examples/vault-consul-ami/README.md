# Vault and Consul AMI
Please refer to Gruntworks [readme](https://github.com/hashicorp/terraform-aws-vault/tree/master/examples/vault-consul-ami) for vault-consul-ami for base module, which is used as *inspiration* for this example.

## Following are *changes* to above gruntwork module
(1) Integrated with git repository, and re-build upon any change to Git repository for vault-consul-ami

(2) Both the Ubuntu and Amazon Linux images are given same suffix (based on current timestamp from variable ami_time) to easily identify all images built together.

(3) Both Ubuntu and Amazon Linux images have same SHA variable value, = git SHA for this folder.

(4) Oracle instant client (from sub directory **ic**) is packed into the image *(in addition to vault and consul)* as well.

(5) Oracle instant client is configured for all users on linux machine (vault user is added to the group for oracle)

(6) Ubuntu image uses local user "ubuntu" home directory, for local file uploads.

(7) Amazon Linux image uses local user "ec2-user" home directory, for local file uploads.

(8) Uses **build.sh** script to build the images, which compares the SHA of git against SHA on image.

(9) **manifest-base.json** is used to create the manifest for the build, as part of post-processor in packer template (base.json).

## Directory Listing
```
├── base.json		// [NEW] template used to drive packer to create the AMI(s).
├── ic			   // [NEW] folder containing instant client, which is uploaded to the image
│   ├── instantclient-basic-linux.x64-12.2.0.1.0.zip
│   └── instantclient-sdk-linux.x64-12.2.0.1.0.zip
├── README.md
├── scripts		  // [NEW]
│   ├── build.sh	 // build script to initiate the packer build
│   └── common.sh	//  - compares the SHA image against SHA of this git repository, to determine if (re)build is needed
├── tasks		    // borrowed from Gruntworks
│   ├── baseline.sh
│   ├── cleanup.sh
│   └── debug.sh
├── tls			   // folder containing TLS certificate(s), generated by executing the module "private-tls-cert"
│   ├── ca.crt.pem
│   ├── README.md
│   ├── vault.crt.pem
│   └── vault.key.pem
```

## Pre-requisites
### Create a local CA Cert & Keys
* [private-tls-cert](https://github.com/hashicorp/terraform-aws-vault/tree/master/modules/private-tls-cert): Generate a private TLS certificate for use with a private Vault cluster. This is done to ensure that we need to accept the ca cert only once, and subsequent integration with the Vault does not warn for https.

  Store the generated certs and keys on _**local**_ file system.
  for this example, these certs are stored at _**tls**_ sub directory.

 **TBD**: Avoid this, and automate generation of ca auth and signed certs after image creation. That would avoid having to create the certs offline first. Perhaps store the certs in Vault.

all the builds and development is done ubuntu bash shell running on windows 10 natively using Atom Editor - ** yay! **

### _**Packer Image**_  (with Vault/Consul and Oracle Instant Client) _, How it is built ?_

Steps executed are as below for building the packer image


```
  update packer.ignore file with keys et. al.
  $ cd examples
  $ vault-consul-ami\scripts\build.sh vault-consul-ami base packer.ignore
  ```
  Build script above takes three parameters


  (1) Directory to compare the SHA signature from, this directory should contain all the configuration files for the packer build.
  In above example it is vault-consul-ami


  (2) Name of the image as json file. IN above example it is `base[.json]`


  (3) `packer.ignore` file *(yup, you need your own credentials ;)* contains all secrets such aws keys et. al. packer.ignore contents look like below

  ```
  {
  "aws_access_key_id" : "XXXXXXXXXXXXXXXX",
  "aws_secret_access_key" : "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "github_oauth_token" : "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "region" : "us-east-1",
  "aws_region" : "us-east-1",
  "vault_version": "0.9.3",
  "vault_module_version": "master",
  "consul_module_version": "master",
  "consul_version": "1.0.6",
  "create_dns_entry":"0",
  "hosted_zone_domain_name": "/hostedzone/ZKPSVQ6E5P27V",
  "vault_domain_name": "vault.analyzeaws.com.",
  "ssh_key_name": "hashicorpKeyPair",
  "ca_public_key_path": "/mnt/c/Users/deepa/source/repos/vault-and-consul/examples/vault-consul-ami/tls/ca.crt.pem",
  "tls_public_key_path": "/mnt/c/Users/deepa/source/repos/vault-and-consul/examples/vault-consul-ami/tls/vault.crt.pem",
  "tls_private_key_path": "/mnt/c/Users/deepa/source/repos/vault-and-consul/examples/vault-consul-ami/tls/vault.key.pem",
  "source_zips_ic": "/mnt/c/Users/deepa/source/repos/vault-and-consul/examples/vault-consul-ami/ic/",
  "target_zips_ic": "oracle/",
  "user_ic": "oracle",
  "source_module_ic": "/mnt/c/Users/deepa/source/repos/vault-and-consul/modules/install-ic/",
  "target_module_ic": "vault/modules/",
  "install_dir_ic": "/opt/oracle"
  }
  ```

 **Generated certs are subsumed into guest OS.**


 [update-certificate-store](https://github.com/hashicorp/terraform-aws-vault/tree/master/modules/update-certificate-store): Add a trusted, CA public key to an OS's certificate store. This allows you to establish TLS connections to services that use this TLS certs signed by this CA without getting x509 certificate errors.


** Image is built, Image is time-stamped, versioned and certs are transferred over. **

Uses a
 [Packer](https://www.packer.io/) template to create a Vault
 [Amazon Machine Image (AMI)](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html), and
 [Ubuntu16 Machine Image (AMI)](https://aws.amazon.com/marketplace/pp/B01JBL2M0O).
 Both the images are provided same suffix based on the timestamp the image was created.
 Image has the tag containing SHA generated from `git` repository as an integrity marker.

 AMI Image integrity is determined by comparing the computed ``git SHA`` *-vis-a-vis-* ``SHA`` tag on AMI image.


**Image pulls & installs vault and consul from github ** (https://github.com/analyzeaws/vault-and-consul)


 [install-vault](https://github.com/analyzeaws/vault-and-consul/tree/master/modules/install-vault):
  Packer template itself rebuilds every time there is change to git repository containing the packing information for the AMI.
